#!/bin/sh /etc/rc.common

START=99

USE_PROCD=1
NAME=prometheus-node-push-influx
PROG=/usr/bin/prometheus-node-push-influx

start_service() {
	enabled=$(uci get prometheus-node-push-influx.main.enabled)
	server=$(uci get prometheus-node-push-influx.main.server_address)
	port=$(uci get prometheus-node-push-influx.main.server_port)
	interval=$(uci get prometheus-node-push-influx.main.interval)

	if [ "$enabled" -eq 1 ] && [ -n "$server" ] && [ -n "$port" ] ; then
		procd_open_instance

		procd_set_param command "$PROG" \
			--server "$server" \
			--port "$port" \
			--interval "$interval" \

		# respawn automatically if something died, be careful if you have an alternative process supervisor
		# if process dies sooner than respawn_threshold, it is considered crashed and after 5 retries the service is stopped
		procd_set_param respawn ${respawn_threshold:-3600} ${respawn_timeout:-5} ${respawn_retry:-5}

		procd_set_param stderr 1 # forward stderr of the command to logd

		procd_close_instance
	else
		echo "service disabled, check uci config"
	fi
}

stop() {
	service_stop $PROG
}

reload() {
	service_reload $PROG
}
